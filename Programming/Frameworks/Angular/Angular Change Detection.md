	16-03-2023
16:54
Authors: 
***
Tags: #stub #angular 
***
# Change Detection

### Механизм

**Отслеживание изменений** - это механизм в Angular, который отвечает за изменение выражений в шаблонах (html) при их изменении в моделях (ts).

Механизм запускается каждый раз, когда, например, инициируется одно из браузерных событий, выполняются HTTP-запросы или вызывается функция `setTimeout()` или `setInterval()`.

В случае с браузерными событиями, Angular расширяет стандартный метод `addEventListener()`, добавляя после вызова "оригинального" обработчика события запуск отслеживания изменений.

На самом деле ключевую роль здесь играет библиотека `zone.js`. В Angular с ее помощью все приложение разделяется на секторы, каждый из которых запоминает контекст асинхронного выполнения. Такой подход после завершения асинхронной операции позволяет запустить механизм отслеживания изменений в нужном секторе.

Запуск механизма `ChangeDetection` в родительском компоненте автоматически инициирует запуск механизма во всех дочерних компонентах.

---

### Default

Механизм отслеживания изменений запускается при любом действии пользователя или изменения состояния приложения (input'ы, поля класса, любое значение крч)

![[Pasted image 20230316174326.png]]

---

### OnPush

Указывается в основном для компонентов, которые необходимы для отображения каких либо статичных данных. Вызывается только при ngOnChanges и при изменении input'ов. Позволяет снизить нагрузку, так как реже вызывается.

При этой стратегии, Angular знает что компонент обновляется только при следующих условиях

-  Observable который прокинут в шаблон и использует пайп `async`, выдает новое значение
-  Изменение значения `@Input` (сравнение идет по `===`).
- Наступление события, на которое подписались в шаблоне через `()` или в коде через `@HostListener`.
 - Проверка запущена руками — например, через `ChangeDetectorRef`.

![[Pasted image 20230316174404.png]]

---

### ChangeDetectorRef

В библиотеке `@angular/core` есть сервис `ChangeDetectorRef`. Он позволяет взять управление механизмом отслеживания изменений полностью под свой контроль.

Основные методы сервиса:

-   `detach()` - полностью отключает механизм `ChangeDetection`;
-   `detectChanges()` - принудительно запускает механизм отслеживания изменений;
-   `reattach()` - используется после вызова `detach()` для активации механизма `ChangeDetection`.

---

### Ручной запуск обнаружения изменений

Существует три метода ручного запуска механизма обнаружения изменений:

-   `detectChanges()` в `ChangeDetectorRef` который запускает обнаружение изменений во view компонента и его дочерних компонентах запоминая стратегию обнаружения изменений. Это может быть использовано в комбинации с detach() для реализации локальных проверок изменений
-   `ApplicationRef.tick()` который запускает обнаружение изменений для всего приложения, соблюдая стратегии обнаружения изменений всех компонентов
-   `markForCheck()` в`ChangeDetectorRef` который **не** запускает обнаружение изменений но помечает все OnPush предков для одноразовой проверки, либо как часть текущего или следующего цикла обнаружения изменений. Он запустит обнаружение изменений для отмеченных компонентов, даже если они используют стратегию OnPush

![[Pasted image 20230316174604.png]]

---

### Запуск кода вне механизма обнаружения изменений

Возможно запустить некий кусок кода вне `NgZone`, в таком случае не будет срабатывать триггер обнаружения изменений.

![[Pasted image 20230316174726.png]]